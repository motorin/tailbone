/*
   app-dust-backbone - v0.0.0
*/
(function(){var a;(a=window.Inn)==null&&(window.Inn={}),Inn.Model=Backbone.Model.extend({url:function(){return"app/models/"+this.id+".json"}})}).call(this),function(){var a;(a=window.Inn)==null&&(window.Inn={}),Inn.Collection=Backbone.Collection.extend({url:function(){return"#"},model:Inn.Model})}.call(this),function(){var a;(a=window.Inn)==null&&(window.Inn={}),Inn.View=Backbone.View.extend({initialize:function(a){return this.options=$.extend({},{templateFolder:"",templateFormat:"js"},a),this},render:function(){var a;return this._renderDeferred&&this._renderDeferred.state()==="pending"?this._renderDeferred:(this.options.layout&&this.options.layout._viewsUnrendered++,this._renderDeferred=new $.Deferred,a=this,this._getTemplate().done(function(){return a.attributes&&(typeof a.attributes=="function"?a.$el.attr(a.attributes()):a.$el.attr(a.attributes)),a.$el.html(a._template(a.getDataForView())),a.trigger("render",a),a._renderDeferred.resolve()}),this._renderDeferred)},_getTemplateURL:function(){var a;return a=this.options.templateFolder?"/":"",this.options.templateURL==null?this.options.templateFolder+a+this._getTemplateName()+"."+this.options.templateFormat:this.options.templateURL},_getTemplateName:function(){return this.options.templateName?this.options.templateName:"b"+this.id[0].toUpperCase()+this.id.slice(1)},_getTemplate:function(){var a;return this.templateDeferred&&this.templateDeferred.state()==="pending"?this.templateDeferred:(this.templateDeferred=new $.Deferred,typeof this._template=="function"?(this.templateDeferred.resolve(),this.templateDeferred):(a=this,$.getScript(this._getTemplateURL(),function(){return a._template=function(a){var b;return b="",dust.render(this._getTemplateName(),a,function(a,c){return b=c}),b},a.templateDeferred.resolve()}),this.templateDeferred))},getDataForView:function(){if(this.model)return this.model.toJSON()},remove:function(){return this.undelegateEvents(),this.$el.empty().remove(),this.trigger("remove"),this.options.isInDOM=!1}})}.call(this),function(){var a;(a=window.Inn)==null&&(window.Inn={}),Inn.Layout=Inn.View.extend({initialize:function(a){if(!(a&&a.dataManager&&a.dataManager instanceof Inn.DataManager))throw new Inn.Error("dataManager should be in options");return this.options=$.extend(!0,{placeholderClassName:"layoutPlaceholder",templateFolder:"",templateFormat:"js"},a),this._dataManager=a.dataManager,this._views=[],this._viewsUnrendered=0,this.id=this.options.id?this.options.id:"layout",_.extend(this,Backbone.Events)},render:function(){var a;return this._renderDeferred&&this._renderDeferred.state()==="pending"?this._renderDeferred:(this._renderDeferred=new $.Deferred,a=this,this._getTemplate().done(function(){return $("#"+a.id).html(a._template()),a._processPartials(),a._parsePartials(),_.each(a.options.partials,function(b,c){if(a.getView(c))return a.getView(c).render()})}),this._renderDeferred)},addView:function(a){var b,c;if(a instanceof Inn.View)return c=_.find(this._views,function(b){return b.id===a.id}),_.indexOf(this._views,a)===-1&&!c&&this._views.push(a),a.options.layout=this,!a.model&&!a.collection&&(b=this._dataManager.getDataAsset(a.id),b?(b instanceof Inn.Model&&(a.model=b),b instanceof Inn.Collection&&(a.collection=b)):(delete a.model,delete a.collection)),a.on("render",_.bind(this._recheckSubViews,this,a)),a.on("remove",_.bind(this._clearSubViews,this,a)),a.on("remove",_.bind(this._onViewRemovedFromDOM,this,a)),this.trigger("add:view",a),this;throw new Inn.Error("view shold be an instance of Inn.View")},getView:function(a){var b;return b=_.find(this._views,function(b){return b.id===a}),b!=null?b:null},removeView:function(a){var b;return b=_.reject(this._views,function(b){return b.id===a}),this._views.length===b.length?null:(this._views=b,this.trigger("remove:view"))},_processPartials:function(a){var b;return b=this,a||(a=this.options.partials),_.each(a,function(a,c){var d;b.addView(new Inn.View({id:c})),d=b.getView(c),d.options._viewBranch=a,a.templateName&&(d.options.templateName=a.templateName),a.templateURL&&(d.options.templateURL=a.templateURL),b.options&&b.options.templateFolder&&(d.options.templateFolder=b.options.templateFolder),b.options&&b.options.templateFormat&&(d.options.templateFormat=b.options.templateFormat),d.attributes=a.attributes;if(a.partials)return b._processPartials(a.partials)}),this},_parsePartials:function(a){var b,c,d;b=this,a||(a=$("#"+b.id)),c=a.attr("id"),d={partials:{}},$(a).children("."+this.options.placeholderClassName).each(function(){return d.partials[$(this).attr("id")]={}});if(!this.options.partials)return this._processPartials(d.partials),this.getView(c)&&(this.getView(c).options._viewBranch=d),_.each(d.partials,function(a,c){if(b.getView(c))return b.getView(c).render()})},_recheckSubViews:function(a){var b;this._viewsUnrendered--,a.el.parentNode===null&&$("#"+a.id).length&&($("#"+a.id).replaceWith(a.$el),a.options.isInDOM=!0),b=this,a.options._viewBranch.partials||this._parsePartials(a.$el),a.options._viewBranch.partials&&_.each(a.options._viewBranch.partials,function(a,c){return b.getView(c).render()});if(this._viewsUnrendered<=0)return this._renderDeferred.resolve()},_clearSubViews:function(a){var b;b=this,this._destroyDeferred&&this._destroyDeferred.notify();if(a.options._viewBranch.partials)return _.each(a.options._viewBranch.partials,function(a,c){if(b.getView(c))return b.getView(c).remove()})},_onViewRemovedFromDOM:function(a){},destroy:function(){var a;return $("#"+this.id).empty(),a=this,this._destroyDeferred=new $.Deferred,this._destroyDeferred.progress(function(){var b;b=_.filter(a._views,function(a){return a.options.isInDOM});if(b.length===0)return this.resolve()}),this._destroyDeferred.done(function(){return _.each(a._views,function(b){return a.removeView(b.id)})}),_.each(a.options.partials,function(b,c){if(a.getView(c))return a.getView(c).remove()}),this._destroyDeferred}})}.call(this),function(){var a;(a=window.Inn)==null&&(window.Inn={}),Inn.DataManager=function(){function a(){this._dataSets=[],_.extend(this,Backbone.Events)}return a.prototype.addDataAsset=function(a,b){if(a instanceof Inn.Model||a instanceof Inn.Collection){if(!a.id&&!b)throw new Inn.Error("dataAsset id is required");return b&&(a.id=b),_.indexOf(this._dataSets,a)===-1&&this._dataSets.push(a),this.trigger("add:dataAsset",a),this}throw new Inn.Error("dataAsset shold be an instance of Inn.Model or Inn.Collection")},a.prototype.getDataAsset=function(a){var b;return b=_.find(this._dataSets,function(b){return b.id===a}),b!=null?b:null},a.prototype.removeDataAsset=function(a){var b;return b=_.reject(this._dataSets,function(b){return b.id===a}),this._dataSets.length===b.length?null:(this._dataSets=b,this.trigger("remove:dataAsset"))},a.prototype.destroy=function(){var a;return a=this,_.each(this._dataSets,function(b){return a.removeDataAsset(b.id)})},a}()}.call(this);