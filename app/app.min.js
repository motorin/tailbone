/*
   app-dust-backbone - v0.0.0
*/
(function(){var a;(a=window.Inn)==null&&(window.Inn={}),Inn.Model=Backbone.Model.extend({url:function(){return"app/models/"+this.id+".json"}})}).call(this),function(){var a;(a=window.Inn)==null&&(window.Inn={}),Inn.Collection=Backbone.Collection.extend({url:function(){return"#"},model:Inn.Model})}.call(this),function(){var a;(a=window.Inn)==null&&(window.Inn={}),Inn.View=Backbone.View.extend({initialize:function(a){return this.options=$.extend({},{templateFolder:"",templateFormat:"js"},a),this},render:function(){var a;return this._renderDeferred&&this._renderDeferred.state()==="pending"?this._renderDeferred:(this.options.layout&&this.options.layout._viewsUnrendered++,this._renderDeferred=new $.Deferred,a=this,this._getTemplate().done(function(){return a.attributes&&(typeof a.attributes=="function"?a.$el.attr(a.attributes()):a.$el.attr(a.attributes)),a.$el.html(a._template(a.getDataForView())),a.trigger("render",a),a._renderDeferred.resolve()}),this._renderDeferred)},_getTemplateURL:function(){var a;return a=this.options.templateFolder?"/":"",this.options.templateURL==null?this.options.templateFolder+a+this._getTemplateName()+"."+this.options.templateFormat:this.options.templateURL},_getTemplateName:function(){return this.options.templateName?this.options.templateName:"b"+this.id[0].toUpperCase()+this.id.slice(1)},_getTemplate:function(){var a;return this.templateDeferred&&this.templateDeferred.state()==="pending"?this.templateDeferred:(this.templateDeferred=new $.Deferred,typeof this._template=="function"?(this.templateDeferred.resolve(),this.templateDeferred):(a=this,$.getScript(this._getTemplateURL(),function(){return a._template=function(a){var b;return b="",dust.render(this._getTemplateName(),a,function(a,c){return b=c}),b},a.templateDeferred.resolve()}),this.templateDeferred))},getDataForView:function(){if(this.model)return this.model.toJSON()},remove:function(){return this.undelegateEvents(),this.$el.empty().remove(),this.trigger("remove"),this.options.isInDOM=!1}})}.call(this),function(){var a,b=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};(a=window.Inn)==null&&(window.Inn={}),Inn.Layout=Inn.View.extend({initialize:function(a){if(!(a&&a.dataManager&&a.dataManager instanceof Inn.DataManager))throw new Inn.Error("dataManager should be in options");return this.options=$.extend(!0,{},Inn.Layout.defaults,a),this._dataManager=a.dataManager,this._views=[],this._viewsUnrendered=0,this.id=this.options.id?this.options.id:"layout",_.extend(this,Backbone.Events)},render:function(){var a=this;return this._renderDeferred&&this._renderDeferred.state()==="pending"?this._renderDeferred:(this._renderDeferred=new $.Deferred,this._getTemplate().done(function(){return $("#"+a.id).html(a._template()),a._processPartials(),a._parsePartials(),_.each(a.options.partials,function(b,c){if(a.getView(c))return a.getView(c).render()})}),this._renderDeferred)},addView:function(a){var c,d;if(a instanceof Inn.View)return d=_.find(this._views,function(b){return b.id===a.id}),b.call(this._views,a)>=0||d||this._views.push(a),a.options.layout=this,!a.model&&!a.collection&&(c=this._dataManager.getDataAsset(a.id),c?(c instanceof Inn.Model&&(a.model=c),c instanceof Inn.Collection&&(a.collection=c)):(delete a.model,delete a.collection)),a.on("render",_.bind(this._recheckSubViews,this,a)),a.on("remove",_.bind(this._clearSubViews,this,a)),a.on("remove",_.bind(this._onViewRemovedFromDOM,this,a)),this.trigger("add:view",a),this;throw new Inn.Error("view shold be an instance of Inn.View")},getView:function(a){var b;return(b=_.find(this._views,function(b){return b.id===a}))!=null?b:null},removeView:function(a){var b;return(b=_.reject(this._views,function(b){return b.id===a})).length===this._views.length?null:(this._views=b,this.trigger("remove:view"))},_processPartials:function(a){var b,c,d;a||(a=this.options.partials);for(b in a)c=a[b],this.addView(new Inn.View({id:b})),d=this.getView(b),d.options._viewBranch=c,c.templateName&&(d.options.templateName=c.templateName),c.templateURL&&(d.options.templateURL=c.templateURL),this.options&&this.options.templateFolder&&(d.options.templateFolder=this.options.templateFolder),this.options&&this.options.templateFormat&&(d.options.templateFormat=this.options.templateFormat),d.attributes=c.attributes,c.partials&&this._processPartials(c.partials);return this},_parsePartials:function(a){var b,c,d,e,f,g,h,i,j,k,l,m;d=this,a||(a=$("#"+this.id)),g=a.attr("id"),h={partials:{}},k=$(a).children("."+this.options.placeholderClassName);for(c=i=0,j=k.length;i<j;c=++i)b=k[c],h.partials[$(b).attr("id")]={};if(this.options.partials==null){this._processPartials(h.partials),this.getView(g)&&(this.getView(g).options._viewBranch=h),l=h.partials,m=[];for(e in l)f=l[e],this.getView(e)?m.push(this.getView(e).render()):m.push(void 0);return m}},_recheckSubViews:function(a){var b,c,d;this._viewsUnrendered--,a.el.parentNode===null&&$("#"+a.id).length&&($("#"+a.id).replaceWith(a.$el),a.options.isInDOM=!0),a.options._viewBranch.partials||this._parsePartials(a.$el);if(a.options._viewBranch.partials){d=a.options._viewBranch.partials;for(b in d)c=d[b],this.getView(b).render()}return this._viewsUnrendered<=0&&this._renderDeferred.resolve(),this},_clearSubViews:function(a){var b,c,d,e;this._destroyDeferred&&this._destroyDeferred.notify();if(a.options._viewBranch.partials){d=a.options._viewBranch.partials,e=[];for(b in d)c=d[b],this.getView(b)?e.push(this.getView(b).remove()):e.push(void 0);return e}},_onViewRemovedFromDOM:function(a){},destroy:function(){var a,b,c,d,e=this;$("#"+this.id).empty(),a=this,this._destroyDeferred=new $.Deferred,this._destroyDeferred.progress(function(){var b;b=_.filter(a._views,function(a){return a.options.isInDOM});if(b.length===0)return this.resolve()}),this._destroyDeferred.done(function(){var b,c,d,f,g;f=a._views,g=[];for(c=0,d=f.length;c<d;c++)b=f[c],g.push(e.removeView(b.id));return g}),d=this.options.partials;for(b in d)c=d[b],this.getView(b)&&this.getView(b).remove();return this._destroyDeferred}}),Inn.Layout.defaults={placeholderClassName:"layoutPlaceholder",templateFolder:"",templateFormat:"js"}}.call(this),function(){var a;(a=window.Inn)==null&&(window.Inn={}),Inn.DataManager=function(){function a(){this._dataSets=[],_.extend(this,Backbone.Events)}return a.prototype.addDataAsset=function(a,b){if(a instanceof Inn.Model||a instanceof Inn.Collection){if(!a.id&&!b)throw new Inn.Error("dataAsset id is required");return b&&(a.id=b),_.indexOf(this._dataSets,a)===-1&&this._dataSets.push(a),this.trigger("add:dataAsset",a),this}throw new Inn.Error("dataAsset shold be an instance of Inn.Model or Inn.Collection")},a.prototype.getDataAsset=function(a){var b;return b=_.find(this._dataSets,function(b){return b.id===a}),b!=null?b:null},a.prototype.removeDataAsset=function(a){var b;return b=_.reject(this._dataSets,function(b){return b.id===a}),this._dataSets.length===b.length?null:(this._dataSets=b,this.trigger("remove:dataAsset"))},a.prototype.destroy=function(){var a;return a=this,_.each(this._dataSets,function(b){return a.removeDataAsset(b.id)})},a}()}.call(this);